<!doctype html>
<html lang="en" class="mocha">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deblok</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" type="image/png" href="assets/favicon.png" />
    <link rel="stylesheet" href="app.css" />
  </head>
  <body class="body">
    <hidden data-modal-target="item-modal"></hidden>
    <overlay> </overlay>
    <nav
      class="flex flex-row p-2 bg-mantle align-middle shadow-lg shadow-mantle/20 z-10"
    >
      <logo class="w-12 h-12 inline-block mr-4">
        <img src="assets/favicon.png" />
      </logo>
      <div class="flex flex-row items-center flex-grow justify-end">
        <a
          href="settings.html"
          class="duration-300 rounded-md hover:bg-mauve/10 p-2 mx-5"
        >
          <i
            data-lucide="settings"
            class="inline text-mauve w-7 h-7 my-auto"
          ></i>
        </a>
      </div>
      <a
        href="javascript:"
        class="flex ml-auto float-right mx-4 z-100 relative"
      >
        <img
          data-dropdown-toggle="profile-dropdown"
          onclick="document.querySelector(`#profile-dropdown`).classList.toggle(`anim__dropdown`)"
          class="pfpico p-0.5 bg-white"
          src="/api/img/identicon.png"
        />
        <div
          id="profile-dropdown"
          onblur="document.querySelector(`#profile-dropdown`).classList.toggle(`anim__dropdown`)"
          class="hidden dropdown"
        >
          <ul class="py-2 text-sm text-text duration-[250ms]">
            <li>
              <a
                href="dash.html"
                class="block px-4 py-2 active-dropdown-color duration-[250ms]"
                >Dashboard</a
              >
            </li>
            <li>
              <a
                href="settings.html"
                class="block px-4 py-2 reg-dropdown-color duration-[250ms]"
              >
                Settings</a
              >
            </li>
            <li>
              <a
                href="#"
                data-modal-target="popup-modal"
                data-modal-toggle="popup-modal"
                class="block px-4 py-2 bg-red-600/20 hover:bg-red-600 duration-[250ms]"
                >Log Out</a
              >
            </li>
          </ul>
        </div>
      </a>
    </nav>
    <br />
      <div class="sessionNavContainer flex flex-row">
      <div class="sessionNav items-center self-center align-middle justify-center py-2 session_collapsed bg-blue-950/60 backdrop-brightness-75 pr-2 p-0.5 backdrop-blur-md !z-[10000] rounded-md flex flex-col w-fit ">
        <button class="w-fit h-fit mb-2 p-2 rounded-md duration-200 bg-red-900 hover:bg-red-800 active:bg-red-700 hover:ring-2 ring-1 ring-red px-4 text-red"
      onclick="UI.disconnect()"
      title="Disconnect">
      <i data-lucide="unplug" class="inline text-red w-5 h-5 "></i>
      
      </button>
      <button class="w-fit h-fit mb-2 p-2 rounded-md duration-200 bg-red-900 hover:bg-red-800 active:bg-red-700 ring-red hover:ring-2 ring-1 px-4 text-red"
      onclick=";UI.disconnect();UI.showStatus('Deleting container...','warning',3000);killContainer();"
      title="Delete Session">
      <i data-lucide="trash-2" class="inline text-red w-5 h-5 "></i>
      
      </button>
      <button class="w-fit h-fit mb-2 p-2 rounded-md duration-200 bg-red-900 hover:bg-red-800 active:bg-red-700 ring-red hover:ring-2 ring-1 px-4 text-red"
      onclick=";UI.rfb.disconnect();UI.showStatus('Restarting container...','warning',3000);restartContainer();"
      title="Restart Session">
      <i data-lucide="rotate-ccw" class="inline text-red w-5 h-5 "></i>
      
      </button>
      <button class="compression align-middle items-center self-center flex flex-row w-fit h-fit mb-2 p-2 rounded-md duration-200 bg-slate-900 hover:bg-slate-800 active:bg-slate-900 hover:ring-2 ring-1 px-4 text-subtext1"
      title="Compression">
      <i data-lucide="fold-vertical" class="inline text-subtext1 w-5 h-5 "></i>
      <div class="mx-2 session_slider">
        <input type="range" onmousemove='UI.forceSetting("compression",this.value)' min="0" max="9" class="!ring-0 m-0 p-0 w-[80px]">
      </div>
      
      </button>
      <button class="compression align-middle items-center self-center flex flex-row w-fit h-fit mb-2 p-2 rounded-md duration-200 bg-slate-900 hover:bg-slate-800 active:bg-slate-900 hover:ring-2 ring-1 px-4 text-subtext1"
      title="Picture Quality">
      <i data-lucide="image-play" class="inline text-subtext1 w-5 h-5 "></i>
      <div class="mx-2 session_slider">
        <input type="range" onmousemove='UI.forceSetting("quality",this.value)' min="0" max="9" class="!ring-0 m-0 p-0 w-[80px]">
      </div>
      
      </button>
      <button class=" align-middle items-center self-center flex flex-row w-fit h-fit mb-2 p-2 rounded-md duration-200 bg-blue-900 hover:bg-blue-800 active:bg-blue-700 hover:ring-2 ring-1 px-4 text-blue"
      title="Toggle Clipboard"
      onclick="toggleClipboard()"
      >
      <i data-lucide="clipboard-type" class="inline text-blue w-5 h-5 "></i>
      
      </button>
    </div>
      <button class="w-fit h-fit session_collapsed expandSessionNav !z-[10000] p-2  rounded-md duration-200 bg-blue-900 hover:bg-blue-800 active:bg-blue-700"
      onclick="let nc=document.querySelector('.sessionNav');
      nc.classList.toggle('session_collapsed');nc.classList.toggle('session_expanded');
      this.classList.toggle('session_collapsed');this.classList.toggle('session_expanded');
      "
      >
        <i
            data-lucide="chevron-right"
            class="inline text-mauve w-6 h-6 my-auto"
          ></i>
      </button>
    </div>

    <iframe class="w-full h-[90%] z-[3] fixed top-[10%] left-0"></iframe>
  </body>
  <script src="modules/global.js"></script>
  <script>
    lucide.createIcons();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
  <script>
    (async () => {
      if (localStorage["DEBLOKAUTH"] != undefined) {
        let tkncheck = await fetch("/api/auth/tokenvalidate", {
          method: "POST",
          body: localStorage["DEBLOKAUTH"],
        });
        if (tkncheck.ok) {
        } else {
          document.location = "login.html";
        }
      } else {
        document.location = "login.html";
      }
    })();
    (() => {
      if (document.location.hash == "#" || document.location.hash == "") {
        document.location = "/";
      }
      console.log(document.location.hash);
      let params = document.location.hash.split(";");
      if (!params || !params[0] || !params[1] || !params[2]) {
        document.write("ERR: all fields are required.");
        return;
      }
      let img = params[0];
      let port = params[1];
      let node = params[2];
      window.img = img
      window.port = port
      window.node = node
      setTimeout(()=>{
        document.querySelector("iframe").src =
        `/vnc/vnc.html?path=ws/${node}/port/${port}/websockify&autoconnect=true&scaling=remote&password=12345678&quality=6&compression=5&logging=info&reconnect=true&reconnect_delay=2000`;
      },200)
      
      // todo actually get from deblokmanager node, but for now we're gonna use slightly lower than inital default keepalive.
      setTimeout(async () => {
        await fetch("/api/container/keepalive", {
          method: "POST",
          body: JSON.stringify({
            id: img.replace("#", ""),
            node: Number(params[2]),
            for: localStorage["username"],
          }),
        });
        
      }, 3000);
      setInterval(async () => {
        await fetch("/api/container/keepalive", {
          method: "POST",
          body: JSON.stringify({
            id: img.replace("#", ""),
            node: Number(params[2]),
            for: localStorage["username"],
          }),
        });
      }, 45000);
      window.history.pushState(
        { pageTitle: "Student Dashboard" },
        "",
        `/#/student/dashboard?__jsession=${crypto.randomUUID()}`,
      );
    })();/*
    setInterval(() => {
      document.querySelector("iframe").contentDocument.querySelector("#noVNC_control_bar_anchor").style.display = "none"
      document.querySelector("iframe").contentDocument.querySelector("#noVNC_control_bar").style.display = "none"
    }, 100);*/
    let UI;
    setTimeout(()=>{
      UI = document.querySelector("iframe").contentWindow.novncui
    },1000)
    setInterval(()=>{
      let ele = document.querySelector("iframe").contentDocument.querySelectorAll(".noVNC_button")
for (let i = 0; i < ele.length; i++) {ele[i].style.display = "none"}
document.querySelector("iframe").contentDocument.querySelector("#noVNC_disconnect_button").style.display = "block";

    },500)
    setInterval(()=>{
      if (!UI.rfb) {UI.connect()}
    },5000)
    let showingClipboard = false;
    function toggleClipboard() {
      let UI = document.querySelector("iframe").contentWindow.novncui
      if (showingClipboard) {
        showingClipboard = !showingClipboard
        UI.closeClipboardPanel()
      }
      else {
        showingClipboard = !showingClipboard
        UI.openClipboardPanel()
      }
    }
    function killContainer() {
      (async () => {
        await fetch("/api/container/kill",{"method":"POST","body":JSON.stringify({"id":img.substring(1),"node":node,"for":localStorage.username})});
        setTimeout(()=>{document.location = "/"},100)
      })();
    }
    function restartContainer() {
      (async () => {
        await fetch("/api/container/restart",{"method":"POST","body":JSON.stringify({"id":img.substring(1),"node":node,"for":localStorage.username})});
        
      })();
    }
  </script>
</html>
